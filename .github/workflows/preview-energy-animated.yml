name: Generate animated energy preview GIF
on:
  workflow_dispatch:
  push:
    branches: [ feat/animated-energy-flow ]
permissions:
  contents: write
jobs:
  build-and-capture:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install deps
        working-directory: webui
        run: |
          npm ci || npm i
          npm i -D puppeteer wait-on serve
      - name: Build
        working-directory: webui
        run: npm run build
      - name: Start preview server
        working-directory: webui
        run: npx serve -s dist -l 8080 &
      - name: Wait for server
        run: npx wait-on http://localhost:8080
      - name: Capture frames with Puppeteer
        run: |
          cat > capture.js <<'JS'
          const fs = require('fs');
          const path = require('path');
          const puppeteer = require('puppeteer');
          (async () => {
            const browser = await puppeteer.launch({args:['--no-sandbox','--disable-setuid-sandbox']});
            const page = await browser.newPage();
            await page.setViewport({width: 1280, height: 720, deviceScaleFactor: 1});
            await page.goto('http://localhost:8080/energy-animated', { waitUntil: 'networkidle2' });
            await page.waitForTimeout(1500);
            const outDir = '/tmp/frames';
            fs.mkdirSync(outDir, { recursive: true });
            const frames = 40; // ~10s @ 4 fps
            for (let i=0;i<frames;i++){
              const p = path.join(outDir, );
              await page.screenshot({ path: p });
              await page.waitForTimeout(250);
            }
            await browser.close();
          })().catch(e=>{ console.error(e); process.exit(1); });
          JS
          node capture.js
      - name: Install ImageMagick
        run: sudo apt-get update && sudo apt-get install -y imagemagick
      - name: Build GIF
        run: |
          convert -delay 25 -loop 0 /tmp/frames/f_*.png webui/public/preview-energy-animated.gif
      - name: Commit and push GIF
        run: |
          git config user.name 'github-actions'
          git config user.email 'actions@github.com'
          git add webui/public/preview-energy-animated.gif
          git commit -m 'ci: update preview-energy-animated.gif' || echo 'no changes'
          git push
